<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HealthCoach - Final Summary</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .app {
      background: transparent;
    }

    .header {
      background: white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      margin-bottom: 0;
      padding: 20px 32px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-small {
      font-size: 32px;
      line-height: 1;
    }

    .header .title {
      color: #2d3748;
      font-weight: 700;
      font-size: 22px;
      margin: 0;
      line-height: 1.2;
    }

    .header .subtitle {
      color: #667eea;
      font-weight: 500;
      font-size: 14px;
      margin: 2px 0 0 0;
    }

    .back-btn {
      background: white;
      color: #667eea;
      border: 2px solid #e8e9eb;
      font-weight: 600;
      transition: all 0.25s ease;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 15px;
      cursor: pointer;
    }

    .back-btn:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .hide { display: none !important; }

    .summary-container { 
      max-width: 900px;
      margin: 20px auto 24px;
    }
    .summary-card { 
      background: white;
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      padding: 32px;
      margin-bottom: 20px;
      border: none;
    }
    h2 {
      color: #2d3748;
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 20px 0;
    }

    h3 {
      color: #2d3748;
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 16px 0;
    }

    .summary-content { margin: 20px 0; }
    .summary-content pre { 
      white-space: pre-wrap; 
      font-family: inherit; 
      margin: 0; 
      line-height: 1.6;
      color: #4a5568;
    }
    
    .comment-section { 
      margin-top: 0;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      padding: 32px;
    }
    .comment-textarea { 
      width: 100%; 
      min-height: 120px; 
      padding: 14px 20px; 
      border-radius: 12px; 
      border: 2px solid #e2e8f0; 
      resize: vertical; 
      font-family: inherit;
      margin-bottom: 16px;
      font-size: 15px;
      outline: none;
      transition: all 0.25s ease;
      background: #f8f9fa;
    }
    
    .comment-textarea:focus {
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .action-btn { 
      padding: 14px 28px; 
      border-radius: 28px; 
      border: 2px solid #e8e9eb; 
      background: white; 
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.25s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .action-btn:hover { 
      background: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .action-btn.primary { 
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
      color: white; 
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }
    .action-btn.primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
    }
    
    .button-container {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .minimal-loading { 
      display: flex; 
      align-items: center; 
      justify-content: center;
      gap: 12px; 
      padding: 40px;
      color: #667eea;
      font-size: 16px;
      font-weight: 500;
    }
    .minimal-spinner { 
      width: 24px; 
      height: 24px; 
      border: 3px solid #e8e9eb; 
      border-top-color: #667eea; 
      border-radius: 50%; 
      animation: spin 0.8s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="logo-small">üë®‚Äç‚öïÔ∏è</div>
        <div>
          <div class="title">HealthCoach</div>
          <div class="subtitle" id="header-subtitle">Final Summary</div>
        </div>
      </div>
      <button class="back-btn" id="back-btn" onclick="goBack()">‚Üê Back</button>
    </div>

    <div id="summary-container" class="summary-container">
      <div id="loading" class="minimal-loading">
        <div class="minimal-spinner"></div>
        <span>Generating summary...</span>
      </div>
    </div>
  </div>

  <script>
  // Application state
  const state = {
    selectedPatientId: null
  };

  // DOM elements
  const els = {
    summaryContainer: document.getElementById('summary-container'),
    loading: document.getElementById('loading'),
    headerSubtitle: document.getElementById('header-subtitle')
  };

  // API helpers
  const api = {
    async getJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error('Request failed: ' + res.status);
      return res.json();
    },
    generateFinalSummary(patientId) {
      return this.getJSON('/generate_final_summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patient_id: patientId })
      });
    },
    saveComment(patientId, comment) {
      return this.getJSON('/save_comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patient_id: patientId, comment })
      });
    }
  };

  // Init
  document.addEventListener('DOMContentLoaded', init);
  async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient_id');
    
    if (!patientId) {
      alert('No patient selected. Redirecting...');
      window.location.href = '/';
      return;
    }

    state.selectedPatientId = patientId;
    
    try {
      const data = await api.generateFinalSummary(patientId);
      displaySummary(data.summary);
    } catch (e) {
      console.error('Error generating summary:', e);
      // Get the stored answers as fallback
      const storedAnswers = sessionStorage.getItem('visitPrepAnswers');
      if (storedAnswers) {
        const answers = JSON.parse(storedAnswers);
        const fallbackSummary = formatAnswersAsSummary(answers);
        displaySummary(fallbackSummary);
      } else {
        alert('Error: Could not generate summary or retrieve answers.');
      }
    }
  }

  function displaySummary(summary) {
    els.loading.remove();
    
    const summaryCard = document.createElement('div');
    summaryCard.className = 'summary-card';
    summaryCard.innerHTML = `
      <h2>üìã Final Summary</h2>
      <div class="summary-content">
        <pre>${escapeHTML(summary || 'No summary available')}</pre>
      </div>
    `;
    
    const commentSection = document.createElement('div');
    commentSection.className = 'comment-section';
    commentSection.innerHTML = `
      <h3>üí¨ Comments</h3>
      <textarea 
        class="comment-textarea" 
        id="comment-textarea" 
        placeholder="Add your comments here..."></textarea>
      <div class="button-container">
        <button class="action-btn" onclick="downloadSummary()">üíæ Download Summary</button>
        <button class="action-btn primary" onclick="saveComment()">üíæ Save Comment</button>
      </div>
    `;
    
    els.summaryContainer.appendChild(summaryCard);
    els.summaryContainer.appendChild(commentSection);
  }

  async function saveComment() {
    const textarea = document.getElementById('comment-textarea');
    const comment = textarea.value.trim();
    
    if (!comment) {
      alert('Please enter a comment before saving.');
      return;
    }
    
    const button = document.querySelector('.action-btn.primary');
    button.disabled = true;
    button.textContent = 'Saving...';
    
    try {
      await api.saveComment(state.selectedPatientId, comment);
      button.textContent = 'Saved ‚úì';
      setTimeout(() => {
        button.textContent = 'Save Comment';
        button.disabled = false;
      }, 2000);
    } catch (e) {
      console.error('Error saving comment:', e);
      alert('Error saving comment. Please try again.');
      button.textContent = 'Save Comment';
      button.disabled = false;
    }
  }

  function downloadSummary() {
    const summaryText = document.querySelector('.summary-content pre')?.textContent;
    const commentText = document.getElementById('comment-textarea')?.value;
    if (!summaryText) return;
    
    let downloadText = summaryText;
    if (commentText?.trim()) {
      downloadText += '\n\n--- Comments ---\n' + commentText;
    }
    
    const blob = new Blob([downloadText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `final_summary_${state.selectedPatientId}_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function goBack() {
    window.location.href = `/visit_prep.html?patient_id=${state.selectedPatientId}`;
  }

  // Format answers as a readable summary
  function formatAnswersAsSummary(answers) {
    let summary = 'Visit Preparation Answers:\n\n';
    
    // Sort answers by question key to maintain order
    const sortedAnswers = Object.entries(answers)
      .sort(([keyA], [keyB]) => {
        // Extract numbers from keys (e.g., "q_1" -> 1)
        const numA = parseInt(keyA.match(/\d+/)?.[0] || '0');
        const numB = parseInt(keyB.match(/\d+/)?.[0] || '0');
        return numA - numB;
      });

    for (const [key, value] of sortedAnswers) {
      if (Array.isArray(value)) {
        summary += `Question ${key}:\n`;
        summary += value.map(v => `- ${v}`).join('\n');
        summary += '\n\n';
      } else {
        summary += `Question ${key}: ${value}\n\n`;
      }
    }

    return summary;
  }

  // Utils
  function escapeHTML(s) { return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }
  </script>
</body>
</html>