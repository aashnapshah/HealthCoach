<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HealthCoach - Visit Preparation</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <style>
    /* Minimal styles for role + layout, works alongside styles.css */
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { max-width: 1024px; margin: 0 auto; padding: 16px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; }
    .title { font-size: 24px; font-weight: 700; }
    .subtitle { font-size: 14px; opacity: 0.8; }
    .hide { display: none !important; }

    .back-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .back-btn:hover { background: #f7f7f7; }

    #stream { margin-top: 16px; display: flex; flex-direction: column; gap: 12px; max-height: calc(100vh - 180px); overflow-y: auto; padding-bottom: 24px; }
    .card, .section-card, .summary-card { border: 1px solid #e5e5e5; border-radius: 12px; background: #fff; padding: 12px; }
    .section-header { border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; }
    .qrow { display: flex; gap: 12px; align-items: flex-start; }
    .qbubble { background: #f0f0f0; border-radius: 10px; padding: 10px; position: relative; max-width: 70%; }
    .avatar-label { display: flex; align-items: center; gap: 8px; }
    .avatar { background: #335; color: #fff; border-radius: 50%; width: 32px; height: 32px; display: grid; place-items: center; font-weight: bold; }
    .opts, .response-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
    .opt, .yes-no-btn, .response-btn, .text-submit-btn, .action-btn, .scale-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .opt:hover, .yes-no-btn:hover, .response-btn:hover, .scale-btn:hover, .text-submit-btn:hover { background: #f5f5f5; }
    .opt.sel, .yes-no-btn.selected, .response-btn.selected, .scale-btn.selected { border-color: #5b8def; background: #eef3ff; }
    .text-input { width: 100%; resize: vertical; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
    .text-input-container { display: grid; gap: 8px; }
    .summary-actions { display: flex; gap: 8px; }
    .action-btn.primary { background: #0b5; color: #fff; border-color: #0a4; }
    .action-btn.primary:hover { background: #0a4; }
    .minimal-loading { display: inline-flex; align-items: center; gap: 8px; opacity: 0.8; }
    .minimal-spinner { width: 16px; height: 16px; border: 2px solid #ccc; border-top-color: #555; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .typing { display: inline-flex; gap: 3px; margin-left: 6px; vertical-align: middle; }
    .typing .dot { width: 6px; height: 6px; border-radius: 50%; background: #bbb; animation: bounce 1.2s infinite ease-in-out; }
    .typing .dot:nth-child(2) { animation-delay: 0.2s; }
    .typing .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
    .fadein { animation: fadein 180ms ease-in; }
    @keyframes fadein { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="logo-small">üë®‚Äç‚öïÔ∏è</div>
        <div>
          <div class="title">HealthCoach</div>
          <div class="subtitle" id="header-subtitle">Visit Preparation</div>
        </div>
      </div>
      <div class="progress-container" id="progress-container">
        <div class="progress-label" id="progress-label"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>
      <button class="back-btn" id="back-btn" onclick="goBack()">‚Üê Back</button>
    </div>

    <!-- Visit Prep Stream -->
    <main id="stream" class="stream" aria-live="polite"></main>
  </div>

  <script>
  // Application state
  const state = {
    selectedPatientId: null,
    currentQuestionKey: null,
    questionsAnswered: 0,
    answers: {},
    currentSection: null,
    questions: {}  // Store all questions for review
  };

  // DOM elements
  const els = {
    stream: document.getElementById('stream'),
    headerSubtitle: document.getElementById('header-subtitle'),
    backBtn: document.getElementById('back-btn')
  };

  // API helpers
  const api = {
    async getJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error('Request failed: ' + res.status);
      return res.json();
    },
    startVisitPrep(patientId) {
      return this.getJSON('/start_visit_prep', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patient_id: patientId })
      });
    },
    submit(patientId, answer, questionKey) {
      return this.getJSON('/submit_answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patient_id: patientId, answer, question_key: questionKey })
      });
    }
  };

  // Init
  document.addEventListener('DOMContentLoaded', init);
  async function init() {
    // Get patient_id from URL
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient_id');
    
    if (!patientId) {
      alert('No patient selected. Redirecting...');
      window.location.href = '/';
      return;
    }

    state.selectedPatientId = patientId;
    
    // Check for saved progress
    const savedProgress = sessionStorage.getItem(`visit_prep_progress_${patientId}`);
    if (savedProgress) {
      const progress = JSON.parse(savedProgress);
      state.answers = progress.answers || {};
      state.questionsAnswered = progress.questionsAnswered || 0;
      state.questions = progress.questions || {};
      
      // Show confirmation to resume or start over
      if (confirm('You have incomplete progress for visit preparation. Would you like to continue where you left off?')) {
        // Resume - reconstruct the UI
        await resumeProgress();
        return;
      } else {
        // Start over - clear saved progress
        sessionStorage.removeItem(`visit_prep_progress_${patientId}`);
      }
    }
    
    showLoadingIndicator();
    
    try {
      const data = await api.startVisitPrep(patientId);
      hideLoadingIndicator();
      state.questionsAnswered = 0;
      state.answers = {};
      displayQuestion(data);
    } catch (e) {
      console.error('Error starting visit prep:', e);
      hideLoadingIndicator();
      alert('Error starting visit preparation. Please try again.');
    }
  }
  
  async function resumeProgress() {
    // Reconstruct UI from saved state
    hideLoadingIndicator();
    
    // Add section header
    const sectionCard = document.createElement('div');
    sectionCard.className = 'section-card fadein';
    sectionCard.dataset.section = 'visit_prep';
    const sectionHeader = document.createElement('div');
    sectionHeader.className = 'section-header visit_prep';
    sectionHeader.innerHTML = '<h2>üéØ Part 2: Visit Preparation</h2>';
    sectionCard.appendChild(sectionHeader);
    els.stream.appendChild(sectionCard);
    
    // Reconstruct all answered questions
    for (const [key, questionData] of Object.entries(state.questions)) {
      const answer = state.answers[key];
      if (answer !== undefined) {
        const card = createQuestionCard(questionData, key);
        card.classList.add('answered');
        
        // Mark the selected answer
        els.stream.appendChild(card);
        setTimeout(() => {
          const answerBtn = card.querySelector(`[onclick*="${key}"]`);
          if (answerBtn) answerBtn.classList.add('sel', 'selected');
        }, 10);
      }
    }
    
    // Get the next question from the server
    showLoadingIndicator();
    try {
      const data = await api.startVisitPrep(state.selectedPatientId);
      hideLoadingIndicator();
      if (data) displayQuestion(data);
    } catch (e) {
      console.error('Error resuming:', e);
      hideLoadingIndicator();
      alert('Error resuming. Starting fresh.');
      window.location.reload();
    }
  }

  function goBack() {
    // Save current progress before going back
    if (state.selectedPatientId) {
      sessionStorage.setItem(`visit_prep_progress_${state.selectedPatientId}`, JSON.stringify({
        answers: state.answers,
        questionsAnswered: state.questionsAnswered,
        questions: state.questions
      }));
    }
    // Go back to medical review (index.html) with patient_id
    window.location.href = `/?patient_id=${state.selectedPatientId}`;
  }

  // Question rendering
  function displayQuestion(data) {
    if (!data) return;
    if (data.complete) {
      displaySummary(data.summary);
      return;
    }

    hideLoadingIndicator();
    state.currentQuestionKey = data.question_key || `q_${state.questionsAnswered}`;
    state.questions[state.currentQuestionKey] = data;  // Store question data
    state.questionsAnswered++;

    // Create question card
    const questionCard = createQuestionCard(data, state.currentQuestionKey);
    
    // Only create section header if it's the first question
    if (state.questionsAnswered === 1) {
      const sectionCard = document.createElement('div');
      sectionCard.className = 'section-card fadein';
      sectionCard.dataset.section = 'visit_prep';

      const sectionHeader = document.createElement('div');
      sectionHeader.className = 'section-header visit_prep';
      sectionHeader.innerHTML = '<h2>üéØ Part 2: Visit Preparation</h2>';

      sectionCard.appendChild(sectionHeader);
      sectionCard.appendChild(questionCard);
      els.stream.appendChild(sectionCard);
    } else {
      els.stream.appendChild(questionCard);
    }
    scrollToBottom();
  }

  function createQuestionCard(data, questionKey) {
    const item = document.createElement('div');
    item.className = 'card fadein';
    item.dataset.questionKey = questionKey;

    item.innerHTML = `
      <div class="qrow">
        <div class="avatar-label">
          <div class="avatar">HC</div>
          <div class="qbubble">
            ${escapeHTML(data.question || 'Question')}
            <span class="typing" id="loading-${questionKey}" style="display:none">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </span>
          </div>
        </div>
      </div>
      <div class="response-options">
        <div class="response-container">
          ${buildResponseOptions(data, questionKey)}
        </div>
      </div>
    `;
    return item;
  }

  function buildResponseOptions(data, questionKey) {
    switch (data.question_type) {
      case 'yes_no':
        return `
          <div class="opts">
            <button class="yes-no-btn yes-btn" onclick="selectAnswer('${questionKey}', 'yes', this)">‚úì Yes</button>
            <button class="yes-no-btn no-btn" onclick="selectAnswer('${questionKey}', 'no', this)">‚úó No</button>
            <button class="yes-no-btn not-sure-btn" onclick="selectAnswer('${questionKey}', 'not_sure', this)">? Not Sure</button>
          </div>
        `;
      case 'multiple_choice':
        const isMultiselect = data.multiselect === true || data.allow_multiple === true;
        return `
          <div class="opts ${isMultiselect ? 'multiselect' : ''}">
            ${(data.options || []).map(option => `
              <button class="opt ${isMultiselect ? 'multiselect' : ''}" 
                onclick="selectAnswer('${questionKey}', '${escapeAttr(option)}', this, ${isMultiselect})"
                data-value="${escapeAttr(option)}">${escapeHTML(option)}</button>
            `).join('')}
          </div>
          ${isMultiselect ? `
            <div class="submit-container">
              <button class="action-btn primary" onclick="submitMultiselect('${questionKey}')">Submit Selection</button>
            </div>
          ` : ''}
        `;
      case 'scale_1_10':
        return `
          <div class="scale-container">
            <div class="scale-labels">
              <span class="scale-label-left">${data.scale_labels?.['1'] || '1'}</span>
              <span class="scale-label-right">${data.scale_labels?.['10'] || '10'}</span>
            </div>
            <div class="opts">
              ${Array.from({length:10},(_,i)=>i+1).map(n=>`
                <button class="scale-btn" onclick="selectAnswer('${questionKey}', '${n}', this)">${n}</button>
              `).join('')}
            </div>
          </div>
        `;
      case 'text':
        return `
          <div class="text-input-container" style="position: relative;">
            <input type="text" class="text-input" 
              placeholder="${escapeAttr(data.placeholder || 'Type your answer...')}"
              onkeypress="if(event.key === 'Enter') { event.preventDefault(); submitTextAnswer('${questionKey}', this.nextElementSibling); }"
              autofocus>
            <button class="text-submit-btn" onclick="submitTextAnswer('${questionKey}', this)" title="Send">‚û§</button>
          </div>
        `;
      default:
        return `
          <div class="opts">
            <button class="opt" onclick="selectAnswer('${questionKey}', 'continue', this)">Continue</button>
          </div>
        `;
    }
  }

  // Answer handlers
  function selectAnswer(questionKey, answer, buttonEl, isMultiselect = false) {
    const container = document.querySelector(`[data-question-key="${CSS.escape(questionKey)}"]`);
    if (!container) return;
    
    if (isMultiselect) {
      buttonEl.classList.toggle('sel');
    } else {
      container.querySelectorAll('.opt, .yes-no-btn, .scale-btn').forEach(btn => btn.classList.remove('sel', 'selected'));
      if (buttonEl) buttonEl.classList.add('sel', 'selected');
      submitAnswerToBackend(questionKey, answer);
    }
  }

  function submitMultiselect(questionKey) {
    const container = document.querySelector(`[data-question-key="${CSS.escape(questionKey)}"]`);
    if (!container) return;
    
    const selectedOptions = Array.from(container.querySelectorAll('.opt.multiselect.sel'))
      .map(btn => btn.dataset.value);
    
    if (selectedOptions.length === 0) {
      alert('Please select at least one option');
      return;
    }
    
    submitAnswerToBackend(questionKey, selectedOptions);
  }

  function submitTextAnswer(questionKey, buttonEl) {
    const container = document.querySelector(`[data-question-key="${CSS.escape(questionKey)}"]`);
    if (!container) return;
    const textInput = container.querySelector('.text-input');
    if (!textInput) return;
    const answer = textInput.value.trim();
    if (!answer) {
      textInput.focus();
      return;
    }
    buttonEl?.classList.add('selected');
    textInput.disabled = true;
    buttonEl.disabled = true;
    submitAnswerToBackend(questionKey, answer);
  }

  async function submitAnswerToBackend(questionKey, answer) {
    state.answers[questionKey] = answer;
    
    // Save progress to sessionStorage
    sessionStorage.setItem(`visit_prep_progress_${state.selectedPatientId}`, JSON.stringify({
      answers: state.answers,
      questionsAnswered: state.questionsAnswered,
      questions: state.questions
    }));
    
    showLoadingIndicator(questionKey);
    try {
      const data = await api.submit(state.selectedPatientId, answer, questionKey);
      hideLoadingIndicator(questionKey);
      const currentCard = document.querySelector(`[data-question-key="${CSS.escape(questionKey)}"]`);
      currentCard?.classList.add('answered');
      
      // Check if complete
      if (data && data.complete) {
        // Clear progress when moving to final summary
        sessionStorage.removeItem(`visit_prep_progress_${state.selectedPatientId}`);
      }
      
      if (data) displayQuestion(data);
    } catch (e) {
      console.error('Error submitting answer:', e);
      hideLoadingIndicator(questionKey);
      alert('Error submitting answer. Try again.');
    }
  }

  // Summary
  function displaySummary(summary) {
    const card = document.createElement('div');
    card.className = 'summary-card fadein';
    card.innerHTML = `
      <h3>üìã Visit Preparation Complete!</h3>
      <div class="summary-actions">
        <button class="action-btn primary" onclick="goToFinalSummary()">Generate Final Summary ‚Üí</button>
      </div>
    `;
    els.stream.appendChild(card);
    scrollToBottom();
  }

  function goToFinalSummary() {
    // Store answers in sessionStorage before redirecting
    sessionStorage.setItem('visitPrepAnswers', JSON.stringify(state.answers));
    window.location.href = `/final_summary.html?patient_id=${state.selectedPatientId}`;
  }

  // Loading indicator
  function showLoadingIndicator(questionKey) {
    if (questionKey) {
      const el = document.getElementById('loading-' + questionKey);
      if (el) el.style.display = 'inline-flex';
      return;
    }
    const el = document.createElement('div');
    el.className = 'minimal-loading';
    el.id = 'loading-indicator';
    el.innerHTML = `<div class="minimal-spinner"></div><span>Processing...</span>`;
    els.stream.appendChild(el);
    scrollToBottom();
  }

  function hideLoadingIndicator(questionKey) {
    if (questionKey) {
      const el = document.getElementById('loading-' + questionKey);
      if (el) el.style.display = 'none';
      return;
    }
    document.getElementById('loading-indicator')?.remove();
  }

  // Download summary
  function downloadSummary() {
    const text = document.querySelector('.summary-content pre')?.textContent;
    if (!text) return;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `visit_prep_summary_${state.selectedPatientId}_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Utils
  function scrollToBottom() { setTimeout(() => { els.stream.scrollTop = els.stream.scrollHeight; }, 50); }
  function escapeHTML(s) { return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }
  function escapeAttr(s) { return escapeHTML(String(s)).replaceAll('"','&quot;'); }
  </script>
</body>
</html>